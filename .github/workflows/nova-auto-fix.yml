name: Nova Auto-Fix

on:
  workflow_dispatch:
    inputs:
      max_iterations:
        description: "Maximum iterations for Nova"
        required: false
        default: "5"
      timeout:
        description: "Timeout in seconds"
        required: false
        default: "300"
  pull_request:
    types: [labeled]

jobs:
  auto-fix:
    # Only run if manually triggered OR if PR has 'nova-fix' label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'nova-fix'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Nova
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run Nova Auto-Fix
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NOVA_ENABLE_TELEMETRY: "true"
        run: |
          nova fix . \
            --max-iters ${{ github.event.inputs.max_iterations || '5' }} \
            --timeout ${{ github.event.inputs.timeout || '300' }}

      - name: Create PR with fixes
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          title: "ðŸ¤– Nova Auto-Fix: ${{ github.event.pull_request.title || 'Manual trigger' }}"
          body: |
            This PR was automatically generated by Nova CI-Rescue.

            Please review the changes carefully before merging.
          branch: nova-fix/${{ github.run_number }}
          commit-message: "fix: automated fixes by Nova CI-Rescue"
